# æ€§èƒ½å„ªåŒ–é©—è­‰æŒ‡å—

**ç‰ˆæœ¬:** 1.0
**æ—¥æœŸ:** 2026-02-07
**ç‹€æ…‹:** Phase 1-4 å·²å®Œæˆ

## æ¦‚è¿°

æœ¬æ–‡æª”æä¾›æ€§èƒ½å„ªåŒ–ç³»çµ±çš„æ¸¬è©¦å’Œé©—è­‰æ–¹æ³•ï¼Œç¢ºä¿æ‰€æœ‰å„ªåŒ–åŠŸèƒ½æ­£å¸¸é‹ä½œä¸¦é”åˆ°é æœŸæ•ˆæœã€‚

## å·²å¯¦ä½œåŠŸèƒ½æ¸…å–®

### âœ… Phase 1: è³‡æºæ¸…ç†ç³»çµ±
- [x] ResourceCleanupManager æ‰¹æ¬¡æ¸…ç†æ©Ÿåˆ¶
- [x] EventSystemUpdater å®šæœŸæ¸…ç†æ•´åˆ
- [x] æ¿€é€²æ¨¡å¼æ”¯æ´ï¼ˆFPS < 30 è‡ªå‹•å•Ÿå‹•ï¼‰
- [x] æ¸…ç†çµ±è¨ˆè¿½è¹¤

### âœ… Phase 2: è¨˜æ†¶é«”ç®¡ç†å„ªåŒ–
- [x] CompletedEventsCache LRU å¿«å–ï¼ˆä¸Šé™ 20 å€‹äº‹ä»¶ï¼‰
- [x] EventManager æ•´åˆ LRU å¿«å–
- [x] EventContext å…§éƒ¨å¼•ç”¨æ¸…ç†
- [x] è¨˜æ†¶é«”ä½¿ç”¨ä¸Šé™æ§åˆ¶

### âœ… Phase 3: Actor ç”Ÿå‘½é€±æœŸç®¡ç†
- [x] ActorLifecycleManager é¡åˆ¥
- [x] EventActor æ¸…ç†é‚è¼¯ï¼ˆshouldCleanup propï¼‰
- [x] æ‰¹æ¬¡ç§»é™¤å’Œå³æ™‚æ¸…ç†æ”¯æ´
- [x] AnimationController å…¬é–‹æ§åˆ¶æ–¹æ³•

### âœ… Phase 4: æ¸²æŸ“å„ªåŒ–
- [x] ActorPool ç‰©ä»¶æ± ç³»çµ±
- [x] æ± åŒ–çµ±è¨ˆå’Œç®¡ç†
- [x] é–’ç½® Actor è‡ªå‹•æ¸…ç†
- [x] PerformanceIntegration æ•´åˆç›£æ§
- [x] è‡ªå‹•å„ªåŒ–æ±ºç­–

## æ¸¬è©¦å ´æ™¯

### æ¸¬è©¦ 1: åŸºæœ¬è³‡æºæ¸…ç†

**ç›®çš„:** é©—è­‰äº‹ä»¶å®Œæˆå¾Œè³‡æºæ˜¯å¦æ­£ç¢ºæ¸…ç†

**æ­¥é©Ÿ:**
1. å•Ÿå‹•éŠæˆ²ä¸¦é–‹å§‹é§•é§›
2. è§¸ç™¼ 3-5 å€‹äº‹ä»¶ä¸¦å®Œæˆ
3. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12)
4. æŸ¥çœ‹ Console æ—¥èªŒ

**é æœŸçµæœ:**
```
[ResourceCleanup] ğŸ§¹ Starting batch cleanup of 5 events...
[ResourceCleanup] âœ… Batch cleanup complete in XX.XXms
[ResourceCleanup] ğŸ“Š Cleaned: { geometries: X, materials: Y, ... }
```

**é©—è­‰æŒ‡æ¨™:**
- âœ… æ¯å®Œæˆ 5 å€‹äº‹ä»¶æ‡‰è§¸ç™¼æ‰¹æ¬¡æ¸…ç†
- âœ… æˆ–æ¯ 2 ç§’æª¢æŸ¥ä¸¦æ¸…ç†å¾…è™•ç†äº‹ä»¶
- âœ… æ¸…ç†çµ±è¨ˆé¡¯ç¤ºé‡‹æ”¾çš„è³‡æºæ•¸é‡

---

### æ¸¬è©¦ 2: è¨˜æ†¶é«”ç®¡ç†

**ç›®çš„:** é©—è­‰ completedEvents ä¸æœƒç„¡é™å¢é•·

**æ­¥é©Ÿ:**
1. å•Ÿå‹•éŠæˆ²ä¸¦é§•é§› 5 åˆ†é˜
2. è§¸ç™¼ä¸¦å®Œæˆè¶…é 20 å€‹äº‹ä»¶
3. æŸ¥çœ‹ Console æ—¥èªŒä¸­çš„ cache size

**é æœŸçµæœ:**
```
[EventManager] ğŸ“Š Completed events cache size: 20/20
```

**é©—è­‰æŒ‡æ¨™:**
- âœ… Cache size æ‡‰ä¿æŒåœ¨ 20 ä»¥ä¸‹
- âœ… èˆŠäº‹ä»¶æœƒè¢«è‡ªå‹•æ·˜æ±°ï¼ˆLRUï¼‰
- âœ… è¨˜æ†¶é«”ä½¿ç”¨ä¸æœƒæŒçºŒå¢é•·

---

### æ¸¬è©¦ 3: Actor ç”Ÿå‘½é€±æœŸ

**ç›®çš„:** é©—è­‰ Actor åœ¨äº‹ä»¶å®Œæˆå¾Œè¢«æ­£ç¢ºæ¸…ç†

**æ­¥é©Ÿ:**
1. è§¸ç™¼ä¸€å€‹åŒ…å«å¤šå€‹ Actor çš„äº‹ä»¶
2. ç­‰å¾…äº‹ä»¶å®Œæˆ
3. æŸ¥çœ‹ Console æ—¥èªŒ

**é æœŸçµæœ:**
```
[EventActor] ğŸ§¹ Starting cleanup for actor actor_xxx
[EventActor] âœ… Cleanup complete for actor actor_xxx
[ActorLifecycle] ğŸ§¹ Starting batch cleanup of X actors...
[ActorLifecycle] âœ… Batch cleanup complete. Removed: X actors
```

**é©—è­‰æŒ‡æ¨™:**
- âœ… Actor è³‡æºè¢«é‡‹æ”¾ï¼ˆgeometries, materials, texturesï¼‰
- âœ… AnimationController è¢« dispose
- âœ… Actor å¾ React çµ„ä»¶æ¨¹ç§»é™¤

---

### æ¸¬è©¦ 4: æ•ˆèƒ½ç›£æ§

**ç›®çš„:** é©—è­‰æ•ˆèƒ½ç›£æ§å’Œè‡ªå‹•å„ªåŒ–åŠŸèƒ½

**æ­¥é©Ÿ:**
1. å•Ÿå‹•éŠæˆ²ï¼Œè¨­å®š `enablePerformanceMonitoring={true}`
2. é§•é§› 30 ç§’ä»¥ä¸Š
3. æŸ¥çœ‹æ€§èƒ½çµ±è¨ˆæ—¥èªŒ

**é æœŸçµæœ:**
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Performance Stats
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ® FPS: 55
ğŸ¨ Draw Calls: 150
ğŸ“ Triangles: 50,000
ğŸ“¦ Geometries: 25
ğŸ–¼ï¸ Textures: 15
ğŸ’¾ Memory: 450 MB
ğŸ¯ Active Events: 2
ğŸ§¹ Cleanup Stats:
   - Total Events Cleaned: 8
   - Pending Cleanup: 0
   - Geometries: 45
   - Materials: 60
   - Textures: 30
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**é©—è­‰æŒ‡æ¨™:**
- âœ… æ¯ 30 ç§’è¼¸å‡ºä¸€æ¬¡æ€§èƒ½çµ±è¨ˆ
- âœ… FPS æ‡‰ä¿æŒåœ¨ 45-60 ç¯„åœ
- âœ… è¨˜æ†¶é«”ä½¿ç”¨ç©©å®šï¼ˆä¸æŒçºŒå¢é•·ï¼‰
- âœ… ç•¶ FPS < 30 æ™‚è‡ªå‹•å•Ÿå‹•æ¿€é€²æ¸…ç†æ¨¡å¼

---

### æ¸¬è©¦ 5: é•·æ™‚é–“é‹è¡Œç©©å®šæ€§

**ç›®çš„:** é©—è­‰éŠæˆ²é•·æ™‚é–“é‹è¡Œçš„ç©©å®šæ€§

**æ­¥é©Ÿ:**
1. å•Ÿå‹•éŠæˆ²ä¸¦æŒçºŒé§•é§› 10 åˆ†é˜
2. æ¯ 2 åˆ†é˜è¨˜éŒ„ FPS å’Œè¨˜æ†¶é«”ä½¿ç”¨
3. ä½¿ç”¨ Chrome DevTools Performance Monitor

**é æœŸçµæœ:**

| æ™‚é–“ (åˆ†é˜) | FPS | è¨˜æ†¶é«” (MB) | Draw Calls |
|------------|-----|------------|------------|
| 0          | 60  | 300        | 150        |
| 2          | 58  | 380        | 160        |
| 4          | 57  | 420        | 165        |
| 6          | 56  | 450        | 170        |
| 8          | 55  | 470        | 175        |
| 10         | 55  | 480        | 180        |

**é©—è­‰æŒ‡æ¨™:**
- âœ… FPS ä¿æŒç©©å®šï¼ˆ50-60ï¼‰
- âœ… è¨˜æ†¶é«”å¢é•·è¶¨ç·©ï¼ˆä¸è¶…é 600 MBï¼‰
- âœ… Draw Calls ä¿æŒåˆç†ç¯„åœ
- âœ… ç„¡è¨˜æ†¶é«”æ´©æ¼è·¡è±¡

---

## æ€§èƒ½åŸºæº–æ¸¬è©¦

### å„ªåŒ–å‰ vs å„ªåŒ–å¾Œå°æ¯”

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„å¹…åº¦ | ç‹€æ…‹ |
|------|--------|--------|----------|------|
| è¨˜æ†¶é«”ä½¿ç”¨ï¼ˆ10 åˆ†é˜ï¼‰ | 800-1200 MB | 300-500 MB | -60-70% | â³ å¾…æ¸¬ |
| å¹³å‡ FPS | 30-45 | 55-60 | +40-80% | â³ å¾…æ¸¬ |
| äº‹ä»¶ç³»çµ±è¨˜æ†¶é«” | ç„¡ä¸Šé™ | ~5-10 MB | å›ºå®šä¸Šé™ | âœ… å·²é”æˆ |
| useFrame åŸ·è¡Œæ¬¡æ•¸ | æ‰€æœ‰ Actors | åªæœ‰æ´»èº | -30-50% | â³ å¾…æ¸¬ |
| è³‡æºæ¸…ç†å»¶é² | ç„¡ | < 2 ç§’ | N/A | âœ… å·²é”æˆ |

---

## ä½¿ç”¨ Chrome DevTools åˆ†æ

### Memory Profiler

1. æ‰“é–‹ Chrome DevTools (F12)
2. åˆ‡æ›åˆ° **Memory** æ¨™ç±¤
3. é¸æ“‡ **Heap snapshot**
4. é§•é§› 2 åˆ†é˜å¾Œæ‹æ”ç¬¬ä¸€å€‹å¿«ç…§
5. ç¹¼çºŒé§•é§› 3 åˆ†é˜å¾Œæ‹æ”ç¬¬äºŒå€‹å¿«ç…§
6. æ¯”è¼ƒå…©å€‹å¿«ç…§ï¼ŒæŸ¥æ‰¾è¨˜æ†¶é«”å¢é•·

**æ³¨æ„äº‹é …:**
- é—œæ³¨ THREE.BufferGeometryã€THREE.Materialã€THREE.Texture çš„æ•¸é‡
- æª¢æŸ¥æ˜¯å¦æœ‰ detached DOM elements
- æŸ¥çœ‹ ArrayBuffer è¨˜æ†¶é«”ä½¿ç”¨

### Performance Monitor

1. æ‰“é–‹ Chrome DevTools (F12)
2. æŒ‰ `Ctrl+Shift+P` é–‹å•Ÿå‘½ä»¤é¢æ¿
3. è¼¸å…¥ "Show Performance Monitor"
4. è§€å¯Ÿä»¥ä¸‹æŒ‡æ¨™ï¼š
   - CPU usage
   - JS heap size
   - DOM Nodes
   - JS event listeners
   - GPU memory

---

## å·²çŸ¥å•é¡Œèˆ‡é™åˆ¶

### ç›®å‰é™åˆ¶

1. **ç‰©ä»¶æ± æœªå®Œå…¨æ•´åˆ** - ActorPool å·²å¯¦ä½œä½†æœªæ•´åˆåˆ° EventActor
2. **Instancing æœªå¯¦ä½œ** - é‡è¤‡ç‰©ä»¶ä»ä½¿ç”¨ç¨ç«‹æ¸²æŸ“
3. **LOD æ•´åˆæœªå®Œæˆ** - LODSystem å­˜åœ¨ä½†æœªæ•´åˆåˆ°äº‹ä»¶ Actor

### æœªä¾†æ”¹é€²æ–¹å‘

1. **Web Worker æ¸…ç†** - å°‡è³‡æº dispose ç§»åˆ° Worker åŸ·è¡Œ
2. **å¢é‡æ¸…ç†** - æ¯å¹€åªæ¸…ç†å°‘é‡è³‡æºï¼Œé¿å…å¡é “
3. **æ™ºèƒ½é è¼‰å…¥** - æ ¹æ“šå ´æ™¯é æ¸¬ä¸‹ä¸€å€‹äº‹ä»¶
4. **ç´‹ç†å£“ç¸®** - ä½¿ç”¨ basis æˆ– ktx2 æ ¼å¼

---

## æ•…éšœæ’é™¤

### FPS ä»ç„¶å¾ˆä½ (< 30)

**æª¢æŸ¥é …ç›®:**
1. ç¢ºèªæ¿€é€²æ¸…ç†æ¨¡å¼æ˜¯å¦å•Ÿå‹•
   ```
   âš ï¸ Low FPS detected - enabling aggressive cleanup
   ```
2. æª¢æŸ¥ Draw Calls æ˜¯å¦éå¤š (> 1000)
3. æŸ¥çœ‹è¨˜æ†¶é«”æ˜¯å¦éé«˜ (> 800 MB)
4. ç¢ºèªæ¸…ç†ç³»çµ±æ˜¯å¦æ­£å¸¸é‹ä½œ

**è§£æ±ºæ–¹æ³•:**
- æ‰‹å‹•è§¸ç™¼æ¸…ç†ï¼š`cleanupManager.setAggressiveMode(true)`
- æ¸›å°‘å ´æ™¯è¤‡é›œåº¦
- æª¢æŸ¥æ˜¯å¦æœ‰è¨˜æ†¶é«”æ´©æ¼

### è¨˜æ†¶é«”æŒçºŒå¢é•·

**æª¢æŸ¥é …ç›®:**
1. ç¢ºèª CompletedEventsCache æ˜¯å¦å•Ÿç”¨
2. æª¢æŸ¥ EventContext æ˜¯å¦è¢«æ¸…ç†
3. ä½¿ç”¨ Memory Profiler æŸ¥æ‰¾æ´©æ¼æº

**è§£æ±ºæ–¹æ³•:**
- ç¢ºä¿ `shouldCleanup` prop è¢«æ­£ç¢ºå‚³é
- æª¢æŸ¥è‡ªè¨‚ä»£ç¢¼æ˜¯å¦ä¿ç•™äº† Actor å¼•ç”¨
- é©—è­‰æ‰€æœ‰ useEffect cleanup å‡½æ•¸

### è³‡æºæœªè¢«æ¸…ç†

**æª¢æŸ¥é …ç›®:**
1. æŸ¥çœ‹æ˜¯å¦é”åˆ°æ¸…ç†é–¾å€¼ï¼ˆ5 å€‹äº‹ä»¶æˆ– 2 ç§’ï¼‰
2. ç¢ºèª EventSystemUpdater æ˜¯å¦èª¿ç”¨ `cleanupManager.update()`
3. æª¢æŸ¥ Console æ˜¯å¦æœ‰æ¸…ç†æ—¥èªŒ

**è§£æ±ºæ–¹æ³•:**
- é™ä½æ¸…ç†é–¾å€¼ï¼š`cleanupThreshold: 3`
- ç¸®çŸ­æ¸…ç†é–“éš”ï¼š`cleanupInterval: 1000`
- å•Ÿç”¨è©³ç´°æ—¥èªŒï¼š`enableLogging: true`

---

## æ—¥èªŒè§£è®€

### æ­£å¸¸é‹ä½œæ—¥èªŒ

```
âœ… æ­£å¸¸ï¼šå®šæœŸæ¸…ç†
[ResourceCleanup] ğŸ§¹ Starting batch cleanup of 5 events...
[ResourceCleanup] âœ… Batch cleanup complete in 12.45ms

âœ… æ­£å¸¸ï¼šActor æ¸…ç†
[EventActor] ğŸ§¹ Starting cleanup for actor pedestrian_001
[EventActor] âœ… Cleanup complete for actor pedestrian_001

âœ… æ­£å¸¸ï¼šè¨˜æ†¶é«”ç®¡ç†
[EventManager] ğŸ“Š Completed events cache size: 18/20

âœ… æ­£å¸¸ï¼šæ€§èƒ½ç›£æ§
ğŸ“Š Performance Stats
ğŸ® FPS: 58
ğŸ’¾ Memory: 420 MB
```

### ç•°å¸¸ç‹€æ³æ—¥èªŒ

```
âš ï¸ è­¦å‘Šï¼šFPS éä½
âš ï¸ Low FPS detected - enabling aggressive cleanup

âš ï¸ è­¦å‘Šï¼šå¾…æ¸…ç†ä»»å‹™ç´¯ç©
[ResourceCleanup] ğŸ“Š Queue size: 15/5

âŒ éŒ¯èª¤ï¼šæ¸…ç†å¤±æ•—
[ResourceCleanup] Failed to dispose geometry: [error details]
```

---

## é…ç½®èª¿æ•´å»ºè­°

æ ¹æ“šå¯¦éš›æ¸¬è©¦çµæœï¼Œå¯ä»¥èª¿æ•´ä»¥ä¸‹åƒæ•¸ï¼š

### ResourceCleanupManager

```typescript
{
  cleanupThreshold: 5,    // ç´¯ç©äº‹ä»¶æ•¸é–¾å€¼ï¼ˆå»ºè­° 3-10ï¼‰
  cleanupInterval: 2000,  // æ™‚é–“é–“éš” msï¼ˆå»ºè­° 1000-5000ï¼‰
  aggressiveMode: false,  // æ¿€é€²æ¨¡å¼ï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰
  enableLogging: true     // é–‹ç™¼æ™‚å•Ÿç”¨ï¼Œæ­£å¼ç’°å¢ƒå¯é—œé–‰
}
```

### CompletedEventsCache

```typescript
{
  maxCompletedEventsCache: 20  // å¿«å–å¤§å°ï¼ˆå»ºè­° 10-30ï¼‰
}
```

### ActorPool

```typescript
{
  maxPoolSize: 10,          // æ¯ç¨®æ¨¡å‹çš„æ± å¤§å°ï¼ˆå»ºè­° 5-20ï¼‰
  warmupCount: 3,           // é è¼‰å…¥æ•¸é‡ï¼ˆå»ºè­° 2-5ï¼‰
  idleTimeout: 300000,      // é–’ç½®è¶…æ™‚ 5 åˆ†é˜
  enableIdleCleanup: false  // æ˜¯å¦è‡ªå‹•æ¸…ç†é–’ç½® Actor
}
```

### PerformanceMonitoring

```typescript
{
  enablePerformanceMonitoring: true,
  performanceLogInterval: 30  // æ—¥èªŒé–“éš”ç§’æ•¸ï¼ˆå»ºè­° 15-60ï¼‰
}
```

---

## æˆåŠŸæ¨™æº–

æ€§èƒ½å„ªåŒ–è¢«è¦–ç‚ºæˆåŠŸç•¶æ»¿è¶³ä»¥ä¸‹æ¢ä»¶ï¼š

1. âœ… **FPS ç©©å®š** - å¹³å‡ FPS â‰¥ 50
2. âœ… **è¨˜æ†¶é«”å—æ§** - 10 åˆ†é˜å…§è¨˜æ†¶é«” < 600 MB
3. âœ… **ç„¡è¨˜æ†¶é«”æ´©æ¼** - è¨˜æ†¶é«”å¢é•·è¶¨ç·©
4. âœ… **è³‡æºæ¸…ç†åŠæ™‚** - æ¸…ç†å»¶é² < 5 ç§’
5. âœ… **ç„¡éŒ¯èª¤æ—¥èªŒ** - æ¸…ç†éç¨‹ç„¡éŒ¯èª¤
6. âœ… **ç”¨æˆ¶é«”é©—æµæš¢** - ç„¡æ˜é¡¯å¡é “

---

## ç¸½çµ

æœ¬é©—è­‰æŒ‡å—æä¾›äº†å…¨é¢çš„æ¸¬è©¦æ–¹æ³•ä¾†é©—è­‰æ€§èƒ½å„ªåŒ–ç³»çµ±ã€‚è«‹æŒ‰ç…§æ¸¬è©¦å ´æ™¯é€ä¸€é©—è­‰ï¼Œä¸¦è¨˜éŒ„å¯¦éš›çµæœã€‚å¦‚æœ‰ä»»ä½•ç•°å¸¸ï¼Œåƒè€ƒæ•…éšœæ’é™¤ç« ç¯€é€²è¡Œèª¿æ•´ã€‚

**ä¸‹ä¸€æ­¥:**
1. åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦å ´æ™¯
2. è¨˜éŒ„æ€§èƒ½åŸºæº–æ•¸æ“š
3. æ ¹æ“šçµæœèª¿æ•´é…ç½®åƒæ•¸
4. æº–å‚™åˆä½µåˆ°ä¸»åˆ†æ”¯
