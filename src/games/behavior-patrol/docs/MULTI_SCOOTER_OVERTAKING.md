# 多台機車搶快超車事件 - 實現指南

## 概述

本文檔說明如何實現「多台機車在公車後方連續搶快超車」的危險事件,通過時序錯開和多角色配置,大幅提高危險行為的可見度和真實感。

## 設計目標

### 問題分析
**單機車的問題**:
- ❌ 只有一次超車機會,玩家可能錯過
- ❌ 事件發生太快,不夠明顯
- ❌ 缺乏連續性,危險感不強

**多機車的優勢**:
- ✅ 連續3波超車,大幅提高可見度
- ✅ 展現真實的"跟風超車"行為
- ✅ 多個危險時刻,更容易被發現
- ✅ 增加場景動態感和壓迫感

## 角色配置

### 1. 公車 (1台)
```typescript
{
  id: 'bus_1',
  name: '正常行駛公車',
  model: '/src/assets/models/Bus_Rigged.glb',
  initialPosition: [37.6, 0, 9.35], // 場景中段
  speed: 6,  // 穩定速度
  time: 0,   // 立即開始
  replayInterval: 20, // 20秒重播
}
```

**作用**: 提供"視線死角"和參照對象,展現大型車的危險性

### 2. 機車組 (3台,每台配騎士)

#### 機車1號 - 最激進 🏍️💨
```typescript
{
  id: 'scooter_1',
  name: '激進超車機車1',
  model: '/src/assets/models/Scooter2_Rigged.glb',
  initialPosition: [20, 0, 9.35],  // 公車後方
  speed: 14,  // 最快(公車的2.3倍!)
  time: 0,    // 立即開始
  duration: 22,
}
```
**特點**: 第一個超車,速度最快,在F點(轉角)超越

#### 機車2號 - 跟隨超車 🏍️💨
```typescript
{
  id: 'scooter_2',
  name: '跟隨超車機車2',
  model: '/src/assets/models/Scooter3_Rigged.glb', // 不同款式
  initialPosition: [15, 0, 8.5],   // 更後方,稍偏移
  speed: 13,  // 稍慢但仍很快
  time: 2.0,  // 延遲2秒(關鍵!)
  duration: 20,
}
```
**特點**: 看到前車超車後跟隨,展現"跟風"行為

#### 機車3號 - 連續超車 🏍️💨
```typescript
{
  id: 'scooter_3',
  name: '連續超車機車3',
  model: '/src/assets/models/Scooter2_Rigged.glb',
  initialPosition: [10, 0, 10.0],  // 最後方
  speed: 12,  // 快速但相對最慢
  time: 4.0,  // 延遲4秒(關鍵!)
  duration: 20,
}
```
**特點**: 第三波超車,形成連續危險行為

## 時序設計

### 時間軸分析

```
時間(秒) │ 公車(速度6)        │ 機車1(速度14)      │ 機車2(速度13)      │ 機車3(速度12)
─────────┼───────────────────┼───────────────────┼───────────────────┼──────────────────
0.0s     │ 🚌 啟動            │ 🏍️ 啟動(後方)      │ [待機]            │ [待機]
         │ 位置: [37.6]       │ 位置: [20]        │                   │
─────────┼───────────────────┼───────────────────┼───────────────────┼──────────────────
2.0s     │ 🚌 行駛中          │ 🏍️ 快速接近        │ 🏍️ 啟動(更後方)   │ [待機]
         │ 位置: [49.8]       │ 位置: [48]        │ 位置: [15]        │
─────────┼───────────────────┼───────────────────┼───────────────────┼──────────────────
4.0s     │ 🚌 行駛中          │ 🏍️ 已超越公車      │ 🏍️ 快速接近       │ 🏍️ 啟動(最後方)
         │ 位置: [62]         │ 位置: [76]        │ 位置: [41]        │ 位置: [10]
─────────┼───────────────────┼───────────────────┼───────────────────┼──────────────────
6.0s     │ 🚌 到達F點(轉角)   │ 🏍️ 遠離           │ 🏍️💥 第2次超車   │ 🏍️ 接近中
         │ 位置: [74.2]       │ 位置: [104]       │ 位置: [67]        │ 位置: [34]
─────────┼───────────────────┼───────────────────┼───────────────────┼──────────────────
8.0s     │ 🚌 轉彎後          │ 🏍️ 完成           │ 🏍️ 已超越         │ 🏍️💥 第3次超車
         │ 位置: [86.4]       │                   │ 位置: [93]        │ 位置: [58]
─────────┼───────────────────┼───────────────────┼───────────────────┼──────────────────
10.0s    │ 🚌 繼續行駛        │                   │ 🏍️ 遠離           │ 🏍️ 已超越
         │ 位置: [98.6]       │                   │                   │ 位置: [82]

⚠️ 危險時刻:
  - T=4-6s: 機車1在F點(轉角)超越公車
  - T=6-8s: 機車2跟隨超越
  - T=8-10s: 機車3連續超越
```

## 關鍵設計點

### 1. 時序錯開 (Staggered Timing)

**原理**: 每台機車間隔2秒啟動
```typescript
機車1: time: 0    // 立即
機車2: time: 2.0  // 延遲2秒
機車3: time: 4.0  // 延遲4秒
```

**效果**:
- 避免同時出現,保持視覺清晰
- 製造"一波接一波"的連續感
- 每2秒就有新的危險事件
- 總危險窗口延長到10秒以上

### 2. 位置錯開 (Position Offset)

```typescript
機車1: [20, 0, 9.35]   // 公車正後方
機車2: [15, 0, 8.5]    // 更後,稍右偏移
機車3: [10, 0, 10.0]   // 最後,稍左偏移
```

**效果**:
- 避免重疊,每台機車獨立可見
- 模擬不同車道或路線
- 增加空間層次感

### 3. 速度梯度 (Speed Gradient)

```typescript
公車:   6  單位/秒  (基準)
機車1: 14  單位/秒  (233% 公車速度)
機車2: 13  單位/秒  (217% 公車速度)
機車3: 12  單位/秒  (200% 公車速度)
```

**效果**:
- 明顯的速度差異,展現"搶快"
- 機車1最快,率先超越
- 梯度速度確保不會互相追撞

### 4. 危險點設計

**F點 (轉角)**: `[106.6, 0, 7.7]`
- 公車轉彎處
- 內輪差危險
- 視線死角最大
- 所有機車在此超越 ⚠️

**I點 (第二轉角)**: `[113.74, 0, 106.27]`
- 第二個危險區域
- 機車1可能在此超越

## 視覺效果對比

### 單機車場景
```
0s  : 🚌────────🏍️
2s  : 🚌──🏍️────
4s  : 🚌🏍️──────
6s  : 🏍️🚌──────  (超車完成)
8s  : ──🏍️🚌────
10s : ────🏍️🚌──  (機車已遠離)
```
**問題**: 超車太快,玩家可能錯過關鍵時刻

### 多機車場景
```
0s  : 🚌─────────🏍️─────🏍️─────🏍️
2s  : 🚌───🏍️────🏍️────🏍️────
4s  : 🚌🏍️──────🏍️───🏍️─────  (機車1超車 ⚠️)
6s  : 🏍️🚌────🏍️🚌──🏍️──────  (機車2超車 ⚠️)
8s  : ──🏍️🚌──🏍️🚌🏍️───────  (機車3超車 ⚠️)
10s : ────🏍️🚌🏍️🏍️────────  (連續危險)
12s : ──────🏍️🏍️🏍️🚌──────  (全部超越)
```
**優勢**: 連續3波危險,持續8-10秒,極高可見度!

## 實現代碼

### 完整配置示例

```typescript
{
  id: 'danger-4',
  name: '機車在公車後方搶快超車',
  description: '公車正常行駛,多台機車從後方視線死角連續高速超車',

  actors: [
    // 公車
    {
      id: 'bus_1',
      name: '正常行駛公車',
      type: ActorType.VEHICLE,
      model: '/src/assets/models/Bus_Rigged.glb',
      initialPosition: [37.6, 0, 9.35],
      initialRotation: [0, Math.PI / 2, 0],
      animationUrls: ['/src/assets/animations/car/Bus_Moving_Animation.glb'],
      replayInterval: 20,
    },

    // 機車1 + 騎士
    {
      id: 'scooter_1',
      name: '激進超車機車1',
      type: ActorType.SCOOTER,
      model: '/src/assets/models/Scooter2_Rigged.glb',
      initialPosition: [20, 0, 9.35],
      initialRotation: [0, Math.PI / 2, 0],
      animationUrls: ['/src/assets/animations/car/Scooter_Moving_Animation.glb'],
      replayInterval: 20,
    },
    {
      id: 'scooter_driver_1',
      name: '激進騎士1',
      type: ActorType.PEDESTRIAN,
      model: '/src/assets/models/Male3_CnH_Rigged.glb',
      initialPosition: [20, 0, 9.35],
      initialRotation: [0, Math.PI / 2, 0],
      animationUrls: ['/src/assets/animations/character/Male_Riding_Scooter_Animation.glb'],
      replayInterval: 20,
    },

    // 機車2 + 騎士 (類似配置,省略)
    // 機車3 + 騎士 (類似配置,省略)
  ],

  actions: [
    // 公車動作
    {
      actorId: 'bus_1',
      type: ActionType.ANIMATION,
      name: 'Bus_Moving_Animation',
      time: 0,
      duration: 40,
      loop: true,
    },
    {
      actorId: 'bus_1',
      type: ActionType.MOVEMENT,
      path: [/* 完整路徑 */],
      speed: 6,
      time: 0,
      duration: 40,
    },

    // 機車1動作
    {
      actorId: 'scooter_1',
      type: ActionType.ANIMATION,
      name: 'Scooter_Moving_Animation',
      time: 0,  // 立即開始
      duration: 22,
      loop: true,
    },
    {
      actorId: 'scooter_1',
      type: ActionType.MOVEMENT,
      path: [/* 從[20]追上並超越 */],
      speed: 14,  // 最快
      time: 0,
      duration: 22,
    },

    // 機車2動作
    {
      actorId: 'scooter_2',
      type: ActionType.ANIMATION,
      name: 'Scooter_Moving_Animation',
      time: 2.0,  // 延遲2秒
      duration: 22,
      loop: true,
    },
    {
      actorId: 'scooter_2',
      type: ActionType.MOVEMENT,
      path: [/* 從[15]追上並超越 */],
      speed: 13,  // 稍慢
      time: 2.0,
      duration: 20,
    },

    // 機車3動作
    {
      actorId: 'scooter_3',
      type: ActionType.ANIMATION,
      name: 'Scooter_Moving_Animation',
      time: 4.0,  // 延遲4秒
      duration: 22,
      loop: true,
    },
    {
      actorId: 'scooter_3',
      type: ActionType.MOVEMENT,
      path: [/* 從[10]追上並超越 */],
      speed: 12,  // 最慢但仍快
      time: 4.0,
      duration: 20,
    },
  ],
}
```

## 調試與優化

### 1. 啟用調試模式

```typescript
<DangerGroup
  danger={danger}
  enableDebug={true}
/>
```

**觀察重點**:
- [ ] 3台機車的路徑點清晰可見
- [ ] 機車從公車後方逐一超越
- [ ] F點(轉角)是主要超車區域
- [ ] 時序間隔2秒,視覺上分開

### 2. 時序微調

**如果機車太密集**:
```typescript
機車1: time: 0
機車2: time: 3.0  // 增加到3秒
機車3: time: 6.0  // 增加到6秒
```

**如果機車太分散**:
```typescript
機車1: time: 0
機車2: time: 1.5  // 減少到1.5秒
機車3: time: 3.0  // 減少到3秒
```

### 3. 速度平衡

**計算公式**:
```
機車追上公車所需時間 = 距離差 / (機車速度 - 公車速度)

例如:
距離差 = 37.6 - 20 = 17.6
速度差 = 14 - 6 = 8
時間 = 17.6 / 8 = 2.2 秒
```

**調整建議**:
- 如果機車太快追上 → 減少速度或增加初始距離
- 如果追不上 → 增加速度或減少初始距離

### 4. 重播間隔

```typescript
replayInterval: 20  // 所有角色統一

計算公式:
重播間隔 = max(所有duration) + 緩衝時間
         = max(40, 22, 20, 20) + 5
         = 40 + 5 = 45秒 (但20秒已足夠,因為關鍵事件在前10秒)
```

## 性能考量

### 角色數量
- 公車: 1台
- 機車: 3台
- 騎士: 3個
- **總計**: 7個3D模型

**優化建議**:
- ✅ 使用相同的機車模型(已優化)
- ✅ 騎士使用不同模型增加變化
- ✅ 重播機制避免重複載入
- ⚠️ 如果性能問題,可減少為2台機車

### LOD (Level of Detail)
```typescript
// 建議在模型中實現LOD
distance < 50: 高細節模型
distance 50-100: 中細節模型
distance > 100: 低細節模型或隱藏
```

## 教學價值

### 危險行為展示
1. **跟風超車**: 看到前車超車就跟隨
2. **轉角超車**: 在視線死角處超車
3. **連續超車**: 多車連續超車增加風險
4. **速度過快**: 明顯超速的危險性

### 問答設計
```typescript
questions: {
  q1: {
    question: '這個情境最大的危險是？',
    options: [
      '機車未依限速行駛',
      '機車在公車旁/後方視線死角搶快超車', // ✓ 正確
      '機車闖紅燈',
      '機車未禮讓行人',
    ],
    correctIndex: 1,
  },
  q2: {
    question: '較安全的做法是？',
    options: [
      '在轉角加速超車更快通過',
      '貼近公車後方,隨時準備鑽縫',
      '保持安全車距,不在轉角與大型車旁超車', // ✓ 正確
      '只要按喇叭就可以超車',
    ],
    correctIndex: 2,
  },
}
```

## 進階變體

### 變體1: 更多機車 (5台)
增加到5台機車,間隔1.5秒

### 變體2: 雙向超車
加入對向車輛,展現對向來車風險

### 變體3: 行人元素
在超車區域添加過馬路行人

### 變體4: 動態難度
根據玩家表現調整機車數量和速度

## 測試檢查清單

- [ ] 3台機車成功加載顯示
- [ ] 公車保持穩定速度6
- [ ] 機車1在0秒啟動,速度14
- [ ] 機車2在2秒啟動,速度13
- [ ] 機車3在4秒啟動,速度12
- [ ] 機車依序從公車後方超越
- [ ] F點(轉角)是主要超車區域
- [ ] 危險時刻持續8-10秒
- [ ] 重播功能正常(20秒間隔)
- [ ] 被找到後所有角色停止
- [ ] 等待期間角色正確隱藏

## 常見問題

### Q1: 機車會不會互相碰撞?
**A**: 不會。位置和時序錯開確保安全間距。

### Q2: 為什麼不是4台或5台機車?
**A**: 3台是平衡點:
- 少於3台 → 效果不明顯
- 多於3台 → 性能負擔,視覺混亂

### Q3: 機車會超過公車多遠?
**A**: 約在F點後20-30單位停止,不會離太遠。

### Q4: 如何確保玩家一定看得到?
**A**:
- 連續3波,持續10秒
- 在主要轉角(F點)發生
- 速度對比明顯
- 重播機制確保多次機會

## 相關文檔

- [REPLAY_FEATURE.md](./REPLAY_FEATURE.md) - 重播功能
- [NO_YIELD_EVENT_GUIDE.md](./NO_YIELD_EVENT_GUIDE.md) - 不禮讓事件
- [ANIMATION_EXAMPLES.md](./ANIMATION_EXAMPLES.md) - 動畫配置

---

**總結**: 多機車設計大幅提升了危險行為的可見度和真實感,通過時序、位置、速度的精心設計,創造出連續且清晰的危險場景,有效傳達交通安全教育訊息。
